name: Run PyTests

on:
  push:
  pull_request:
    branches: ["master"]   

env:
  PY_COLORS: 1

  
jobs:
  build:
    name: Python ${{ matrix.python-version }} ${{ matrix.os }} ${{ matrix.mpi }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:        
        os: [ "ubuntu-18.04", "macos-11" ]
        python-version: ["3.7", "3.8", "3.9" ]
        mpi: [mpich, openmpi]
        include:
        - os: ubuntu-18.04
          mpi: mpich
          install-mpi: sudo apt install -y mpich libmpich-dev
        - os: ubuntu-18.04
          mpi: openmpi
          install-mpi: sudo apt install -y openmpi-bin libopenmpi-dev
        - os: macos-11
          mpi: mpich
          install-mpi: brew install mpich
        - os: macos-11
          mpi: openmpi
          install-mpi: brew install openmpi

    steps:
      - name: Checkout  ðŸ›Žï¸
        uses: "actions/checkout@v2"    

      - name: Install MPI ðŸ“¥
        run: |
          ${{ matrix.install-mpi }}
          mpirun --version

          which mpirun
          

      - name: Set up Python ${{ matrix.python-version }}  ðŸ
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}

      - name: System Info  ðŸ’»
        run: |
          python -c "from multiprocessing import cpu_count ; print('cpu_count={}'.format(cpu_count()))"

          if [ "$RUNNER_OS" == "macOS" ]; then
              echo "***************************"
              system_profiler SPHardwareDataType
              echo "***************************"
          elif [ "$RUNNER_OS" == "Linux" ]; then
              echo "***************************"          
              lscpu | egrep 'Model name|Socket|Thread|NUMA|CPU\(s\)'
              lshw -short -C memory
              echo "***************************"
          fi

          python3 --version
          python --version

      - name: Install Python Dependencies ðŸ“¥
        run: |
          python3 -m pip install --upgrade pip wheel
          python3 -m pip install --upgrade -r requirements.txt

      - name: Test with pytest ðŸš€
        run: |
          python3 setup.py install      
          git clone https://github.com/djgroen/FabFlee.git         
          
          export TMPDIR=/tmp
          export OMPI_MCA_btl=self,tcp
          export OMPI_MCA_btl_vader_backing_directory=/tmp

          cd FabFlee/config_files/mali
          mpirun -np 2 python3 run_par.py input_csv source_data 10 simsetting.csv > out.csv
          cd ../../..

          python3 -m pytest --log-cli-level=DEBUG tests/

